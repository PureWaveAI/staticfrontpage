[variables]
# Default PORT for local builds; most platforms will override this
PORT = "80"

[phases.setup]
# Install nginx and envsubst (from gettext) from Nixpkgs
nixPkgs = ['nginx', 'gettext']

[phases.build]
# Copy the static site (exactly the contents of ./app) into nginx's web root
# and use our custom nginx config
cmds = [
  'mkdir -p /var/www/html',
  'cp -r app/. /var/www/html/',
  'mkdir -p /etc/nginx',
  'cp -r docker/nginx.conf /etc/nginx/nginx.conf'
]

[start]
# Ensure log directory exists, render PORT into nginx.conf, then run nginx
cmd = "mkdir -p /var/log/nginx && PORT=${PORT:-80} envsubst '$PORT' < /etc/nginx/nginx.conf > /tmp/nginx.conf && exec nginx -c /tmp/nginx.conf -g 'daemon off;'"